@startuml TC_LOGIN_003
title Sequence Diagram Test: TC_LOGIN_003 - Đăng nhập thất bại khi mật khẩu sai

autonumber

actor "Tester" as tester

participant testClass as ":AuthServiceTest"
participant authService as ":AuthService"
participant fakeUserRepo as ":FakeUserRepository"
participant fakePasswordEncoder as ":FakePasswordEncoder"

note left of tester
    Unit Test: Kiểm tra đăng nhập
    thất bại khi mật khẩu
    không chính xác
end note

== Arrange ==

tester -> testClass : testAuthWrongPassword()
activate testClass

testClass -> testClass : loginRequest = new LoginRequest("hyan123", "haha123")

== Action ==

testClass -> testClass : assertThrows(AuthException.class, () -> {...})
activate testClass

testClass -> authService : authenticate(loginRequest: LoginRequest)
activate authService

authService -> fakeUserRepo : findByUsername("hyan123")
activate fakeUserRepo

note left of fakeUserRepo
    Fake data: username "hyan123" tồn tại
    với password "password123_encoded"
end note

fakeUserRepo --> authService : Optional.of(fakeUser)
deactivate fakeUserRepo

authService -> fakePasswordEncoder : matches("haha123", "password123_encoded")
activate fakePasswordEncoder

note left of fakePasswordEncoder
    Fake logic: "haha123" + "_encoded" == "password123_encoded"
    "haha123_encoded" != "password123_encoded" → false
end note

fakePasswordEncoder --> authService : false
deactivate fakePasswordEncoder

authService --> testClass : throw AuthException("Mật khẩu không chính xác", UNAUTHORIZED)
deactivate authService

deactivate testClass

== Assert ==

testClass -> testClass : assertEquals("Mật khẩu không chính xác", exception.getMessage())

alt Basic Flow: AuthException được ném và message đúng
    testClass --> tester : ✅ Test PASSED
else Exception Flow: Không có exception hoặc message sai
    testClass --> tester : ❌ Test FAILED
end

deactivate testClass

@enduml
